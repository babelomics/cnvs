<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<!--<link rel="import" href="../bower_components/stevia-elements/src/ontology/stv-hpo.html">-->
<link rel="import" href="../bower_components/stevia-elements/src/table/stv-table.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-search.html">
<link rel="import" href="cnvs-syndrome.html">
<link rel="import" href="cnvs-ethnic.html">


<dom-module id="add-multiple-cnv">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            background-color: var(--light-secondary-color);
            @apply(--layout-horizontal);
            overflow-y: scroll;
        }

        .right,
        .left {
            position: relative;
            box-sizing: border-box;
            padding: 10px;
            width: 250px;
            min-width: 250px;
        }

        .right {
            @apply(--layout-flex);
            padding-left: 0;
        }

        textarea {
            resize: none;
        }

        .searchGene {
            margin-top: 5px;
        }

        .container > span {
            margin-left: 10px;
        }

        #tools {
            margin-top: 10px;
        }


        .stv-formbox,
        #tablaresultadosPanel {
            box-shadow: 0px 0px 3px 1px rgba(0, 0, 0, 0.2);
        }

        #tablaresultados {
            border-top: 1px solid #d3d3d3;
        }

        #tablaresultadosPanel {
            border: 1px solid #d3d3d3;
        }

        .stv-formcontent {
            display: none;
        }
        stv-search{
            padding: 0px;
            margin:0px;
            width:198px;
        }
        stv-table {
            overflow-y: auto;
        }

        stv-table::shadow .table-header-field > .name.stv-table {
            padding: 4px 0;
        }

        stv-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }
        stv-table.small::shadow .table-row {
            height:30px;
        }

        stv-table.big::shadow .table-row {
            height:50px;
        }
        /*.stv-formbox  img{


        }*/

        .stv-formtitle img {
            float: right;
            /* background: #006699;*/
            height: 20px;
            width: 20px;
            -moz-transition: all 0.2s ease-in-out;
            -webkit-transition: all 0.2s ease-in-out;
            -o-transition: all 0.2s ease-in-out;
            transition: all 0.2s ease-in;
        }

        .toggleElement {
            display: block;
        }
        .input_container {
            margin-bottom: 5px;
        }
        .input_container >label{
            /*color: #225e71;*/
            color: black;
        }
        .stv-control >span{
            color:gray;
        }
        .logo{
            max-height: 40px;
            max-width: 90px;
            margin: 10px;
        }
        #inheritance span{
            font-size: 12px;
        }

    </style>
    <template>
        <div class="right vertical layout">
            <form>
                <div class="form_block positionBlock horizontal layout">
                        <input type="file" id ="cnvsFile" name="cnvsFile" accept="application/vnd.sealed-xls">
                        <div class="stv-btn stv-btn-shdw" on-click="readXLSX" title="read">Read File</div>
                </div>
            </form>

            <div id="add_cnvs" class="horizontal layout" style="margin:10px 0px 15px 0px;">
                <div>
                    <span style="color: #006699; margin: 10px;" >  Total cases:  {{totalcaseValue}}</span>
                </div>

            </div>
            </br>
            <stv-panel collapsible id="tablaresultadosPanel">
                <div class="header">
                    CNVS READ
                </div>
                <stv-table id="tablaread" class="container small" page-size="10" enable-paging enable-remote enable-select enable-resize data="{{data}}" columns="{{columns}}" on-rowclick="handleRowClick" on-column-visibility-change="handleColumnVisibilityChange">
                    <div class="custom-buttons horizontal layout">
                        <button style="margin-right: 10px; color: #006699" id="saveTable" class="stv-btn down" on-click="upload" data-file="{{cnv}}"><i class="fa fa-cloud-upload"></i> upload</button>
                        <button id="spamButtonTable" class="stv-btn" on-click="spamTable" disabled>expand</button>
                        <button id="compressButtonTable"class="stv-btn" on-click="compressTable">compress</button>
                    </div>
                </stv-table>
            </stv-panel>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'add-multiple-cnv',
        properties: {
            userData:{
                type:Object
            },
            totalcaseValue: {
                type: Number,
                value: 0
            },
            columns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            data:{
                type: Array,
                value: function() {
                    return [];
                }
            },
            query:{
                type: Object,
                value: function() {
                    return {}
                }
            },
            formURL: {
                type: String,
                value: "",
                observer: 'urlChanged'
            },
        },
        handleColumnVisibilityChange: function(){
            var small = true;
            for ( var i = 31; i < this.columns.length; i++){
                if ( this.columns[i].visible){
                    small = false;
                }
            }
            if(small){
                this.$.tablaread.set('pageSize',10);
                this.$.tablaread.classList.remove('big');
                this.$.tablaread.classList.add('small');
            }else{
                this.$.tablaread.set('pageSize',6);
                this.$.tablaread.classList.remove('small');
                this.$.tablaread.classList.add('big');
            }
        },
        compressTable: function(){
            for ( var i = 0; i < 31; i++){
                this.set('columns.'+i+'.visible', false);
            }
            for ( var i = 31; i < this.columns.length; i++){
                this.set('columns.'+i+'.visible', true);
            }
            this.$.tablaread.refresh();
            this.$.compressButtonTable.setAttribute('disabled',"");
            this.$.spamButtonTable.removeAttribute('disabled');
            this.handleColumnVisibilityChange();
        },
        spamTable: function(){
            for ( var i = 0; i < 31; i++){
                this.set('columns.'+i+'.visible', true);
            }
            for ( var i = 31; i < this.columns.length; i++){
                this.set('columns.'+i+'.visible', false);
            }
            this.$.tablaread.refresh();
            this.$.spamButtonTable.setAttribute('disabled',"");
            this.$.compressButtonTable.removeAttribute('disabled');
            this.handleColumnVisibilityChange();
        },
        enablePrenatal: function(){
            if(this.$.prenatalAdd.checked){
                this.$.agePrenatalAdd.disabled = false;
                this.$.labelageprenatal.style.color = "black";
                this.ageValue = "Prenatal";
                this.$.ageAdd.disabled = true;
            }else{
                this.$.agePrenatalAdd.disabled = true;
                this.$.labelageprenatal.style.color = "gray";
                this.$.ageAdd.disabled = false;
            }

        },
        readXLSX: function(){
            var file = this.$.cnvsFile.files[0]
            var reader = new FileReader();
            var me = this;
            reader.onload = function(e) {
                var data = e.target.result;
                var workbook = XLSX.read(data, {type: 'binary'});
                me.procesarWorkbook(workbook);
            }
            reader.readAsBinaryString(file);
        },
        procesarWorkbook: function(workbook){

            var sheet_name_list = workbook.SheetNames;
            var me = this;
            sheet_name_list.forEach(function(y) { /* iterate through sheets */
                var sheetsList;
                var worksheet = workbook.Sheets[y];
                var c = XLSX.utils.sheet_to_json(worksheet);
                for (var i = 0; i < c.length; i++){
                    console.log(c[i], i);
                    me.addCNV(c[i], i);
                }
            });
        },
        addCNV: function(z, index){
            var validateForm = true;
            var newRow = {};

            //not required
            if(z.hasOwnProperty("01-Decipher ID")){
                newRow.decipherId = z["01-Decipher ID"];
            }

            //required one
            if(z.hasOwnProperty("02-Local ID 1")){
                newRow.centerId1 = z["02-Local ID 1"] ;
            }else{
                alert("Insert Local Id, please")
                validateForm = false;
            }

            if(z.hasOwnProperty("02-Local ID 2")){
                newRow.centerId2 = z["02-Local ID 2"];
            }

            if(z.hasOwnProperty("02-Local ID 3")){
                newRow.centerId3 = z["02-Local ID 3"];
            }

            //not required Facultativo
            if(z.hasOwnProperty("20-Year of Birth")){
                newRow.yearOfBirth = z["20-Year of Birth"];
            }

            //not required Facultativo
            if (z.hasOwnProperty("21-Year test performed")) {
                newRow.yearTest = z["21-Year test performed"];
            }

            //not required Facultativo
            if(z.hasOwnProperty("22-Age")){
                newRow.age = z["22-Age"];

                if(z["22-Age"] == "Prenatal"){
                    if(z.hasOwnProperty("23-Age in weeks (only for prenatal)")){
                        newRow.agePrenatal = z["23-Age in weeks (only for prenatal)"];
                    }else{
                        alert("Insert Age Prenatal, please")
                        validateForm = false;
                    }
                }
            }

            //not required Facultativo
            if(z.hasOwnProperty("24-Ethnic group")){
                newRow.ethnicGroup = z["24-Ethnic group"];
            }

            //not required Facultativo
            if(z.hasOwnProperty("25-Geographic origin")){
                newRow.origin = z["25-Geographic origin"];
            }

            if(z.hasOwnProperty("16-Status")){
                newRow.status = z["16-Status"];
            }else{
                validateForm = false;
                alert("Insert Status, please")
            }

            if(z.hasOwnProperty("14-Cell line")){
                newRow.cellLine = z["14-Cell line"];
            }else{
                validateForm = false;
                alert("Insert Cell line, please")
            }

            if(z.hasOwnProperty("17-Type of sample")){
                newRow.typeSample = z["17-Type of sample"];
            }else{
                validateForm = false;
                alert("Insert Type of Sample, please")
            }

            if(z.hasOwnProperty("15-Chromosomal gender")){
                newRow.chromGender = z["15-Chromosomal gender"];
            }else{
                validateForm = false;
                alert("Insert Chr gender, please")
            }

            //not required Facultativo
            if(z.hasOwnProperty("26-Array platform")) {
                newRow.arrayPlatform = z["26-Array platform"];
            }

            //not required Facultativo
            if(z.hasOwnProperty("27-array ID")) {
                newRow.arrayId = z["27-array ID"];
            }

            if(z.hasOwnProperty("29-Comments")) {
                newRow.comments = this.commentsValue;
            }

            if(z.hasOwnProperty("03-Chromosome")){
                newRow.chromosome = z["03-Chromosome"];
            }else{
                validateForm = false;
                alert("Insert Chromosome, please")
            }

            if(z.hasOwnProperty("04-Start")){
                newRow.start = z["04-Start"];
            }else{
                validateForm = false;
                alert("Insert Start, please")
            }

            if(z.hasOwnProperty("05-End")){
                newRow.end = z["05-End"];
            }else{
                validateForm = false;
                alert("Insert End, please")
            }


            if (z.hasOwnProperty("08-Type of variant")) {
                newRow.type = z["08-Type of variant"];
            }else{
                validateForm = false;
                alert("Insert Type of variant, please")
            }

            if(z.hasOwnProperty("13-Number of variants")) {
                newRow.nv = z["13-Number of variants"];
            }else{
                validateForm = false;
                alert("Insert Number of variants, please")
            }

            if (z.hasOwnProperty("09-Doses")) {
                newRow.doses = z["09-Doses"];
            }else{
                validateForm = false;
                alert("Insert Doses, please")
            }

            if( z.hasOwnProperty("10-Mean ratio")){
                newRow.dosesNum =  z["10-Mean ratio"];
            }else{
                validateForm = false;
                alert("Insert Doses Number, please")
            }
            //TODO hacer ws para que se traiga directamente la cytobanda

            if(z.hasOwnProperty("07-Band")){
                newRow.band = z["07-Band"].split(",");
            }else{
                validateForm = false;
                alert("Insert the cytoband, please")
            }


            if (z.hasOwnProperty("06-Assembly")) {
                newRow.assembly = z["06-Assembly"];
            }else{
                validateForm = false;
                alert("Insert assembly, please")
            }

            if(z.hasOwnProperty("18-Referral diagnosis")) {
                newRow.referalDiag = z["18-Referral diagnosis"].split(";");
            }


            if (z.hasOwnProperty("19-Phenotype (HPO)")) {
                newRow.phenotype = z["19-Phenotype (HPO)"].split(",");
            }
//            }else{
//                alert("Insert Phenotype");
//            }

            if(z.hasOwnProperty("28-Aneuploidy-Deletion/Duplication Syndrome")){
                newRow.syndromeName = z["28-Aneuploidy-Deletion/Duplication Syndrome"].split(",");
            }

            if(z.hasOwnProperty("12-Inheritance")){
                newRow.inheritance = z["12-Inheritance"];
            }else{
                validateForm = false;
                alert("Insert inheritance, please")
            }

            if(z.hasOwnProperty("11-Clinical significance")){
                newRow.clinicalSig = z["11-Clinical significance"];
            }else{
                validateForm = false;
                alert("Insert clinical significance, please")
            }


            newRow.author = this.userData.name;
            newRow.organization = this.userData.attributes.group;
            if(validateForm){
                this.push('data', newRow);
            }else{
                alert("Check the CNV number" + index);
            }
            console.log(newRow);
        },

        showHPO: function() {
            this.$.hpoPanelAdd.hidden = !this.$.hpoPanelAdd.hidden;
            // this.$.hpoPanel.handleClearSelected();
        },
        hpoValueChanged: function(neo, old) {
            if (neo) {
                var hpoName = [];
                for (var i = 0; i < neo.length; i++) {
                    hpoName.push(neo[i].n);
                }
                this.hpoSearch = hpoName.join(",");
            }
        },
        clearHPO: function(){
            this.hpoSearch = "";
            this.hpoValue = [];
        },
        showSyndrome: function() {
            this.$.syndromePanelAdd.hidden = !this.$.syndromePanelAdd.hidden;
        },
        syndromeValueChanged: function(neo, old) {
            if (neo) {
                var syndromeName = [];
                for (var i = 0; i < neo.length; i++) {
                    syndromeName.push(neo[i].n);
                }
                this.syndromeSearch = syndromeName.join(",");
            }
        },
        clearSyndrome: function(){
            this.syndromeSearch = "";
            this.syndromeValue = [];
        },
        showEthnic: function() {
            this.$.ethnicPanelAdd.hidden = !this.$.ethnicPanelAdd.hidden;
        },
        ethnicValueChanged: function(neo, old) {
            if (neo) {
                var ethnicName = [];
                for (var i = 0; i < neo.length; i++) {
                    ethnicName.push(neo[i].n);
                }
                this.ethnicSearch = ethnicName.join(",");
            }
        },
        clearEthnic: function(){
            this.ethnicSearch = "";
            this.ethnicValue = [];
        },
        cnvToString: function(o){
            return o.code + "\t" + o.decipherId + "\t" + o.chromosome + "\t" + o.start + "\t" + o.end + "\t" + o.status + "\t" + o.typeSample
                    + "\t" + o.cellLine + "\t" + o.chromGender + "\t" + o.band + "\t" + o.assembly + "\t" + o.nv + "\t" + o.type + "\t" +
                    o.doses + "\t" + size + "\t" + o.genes + "\t" + o.referalDiag + "\t" + o.syndrome + "\t" + o.phenotype + "\t" +
                    o.clinicalSig + "\t" + o.inheritance + "\t" + o.yearOfBirth + "\t" + o.yearTest + "\t" + o.age + "\t" + o.agePrenatal
                    + "\t" + o.ethnicGroup + "\t" + o.origin + "\t" + o.arrayPlatform + "\t" + o.arrayId + "\t" + o.comments +"\n";
        },

        calculateGenes:function(){

            var positions = [];
            var me = this;
            var variant = this.regionValueC + ":" + this.regionValueS + "-" + this.regionValueE;
            positions.push(variant);

            // Annotate
            var query = positions.join(",");
            if (positions.length > 0) {

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'region',
                    resource: 'gene',
                    query: query,
                    params: {
                        exclude: "transcripts,chunkIds,expressionValues,_chunkIds,mirna"
                    },
                    async: false,
                    success: function(response) {
                        try {
                            for (var i = 0; response != null && i < response.response.length; i++) {
                                var result = response.response[i].result;

                                var genes = [];
                                for (var j = 0; j < result.length; j++) {
                                    var gene = result[j];
                                    genes.push(gene.name);
                                }

                            }

                            me.geneValue = genes.join(",");
                        } catch (e) {}
                    }
                });
            }

        },
        //Search Gens in textarea
        handleGeneSearchSelect: function(e) {
            var name = e.detail.name;
            // if (this.selectedGeneMap[name] == null) {
            this.addGene(name);
            //}
        },
        addGene: function(name){
            if(this.$.geneAdd.value == null || this.$.geneAdd.value == ""){
                this.$.geneAdd.value = name;
            }else{
                this.$.geneAdd.value = this.$.geneAdd.value + "," + name;
            }
        },
        _initGeneSearch: function() {
            var me = this;
            var search = function(query, cb) {
                var results = [];

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'feature',
                    subCategory: 'id',
                    query: query,
                    resource: 'starts_with',
                    params: {
                        limit: 10
                    },
                    async: false,
                    success: function (data, textStatus, jqXHR) {
                        results = data.response[0].result;
//
                    }
                });
                cb(results);
            };
        },
        ready: function() {
            var me = this;

            this.totalcaseValue = ALL_CASE;
            this.species = 'Homo sapiens';
            this._initGeneSearch();


            this.columns = [{
                name: 'position',
                title: 'Position',
                width: 280,
                columns: [{
                    name: 'chromosome',
                    title: 'Chr',
                    width: 60,
                    formula: function(row) {
                        return row.chromosome;
                    }
                }, {
                    name: 'start',
                    title: 'Start',
                    width: 60,
                    formula: function(row) {
                        return row.start;
                    }
                }, {
                    name: 'end',
                    title: 'End',
                    width: 60,
                    formula: function(row) {
                        return row.end;
                    }
                }, {
                    name: 'size',
                    title: 'Size(nt)',
                    width: 100,
                    formula: function(row) {
                        return row.end - row.start;
                    }
                }]
            }, {
                name: 'code',
                title: "Code",
                width: 60,
                formula: function(row){
                    var n = me.transformData(row.code);
                    return n;
                }
            }, {
                name: 'decipherId',
                title: 'DecipherId',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.decipherId);
                    return n;
                }
            }, {
                name: 'LocalID',
                title: 'Local ID',
                width: 180,
                columns: [{
                    name: 'centerId1',
                    title: 'ID 1',
                    width: 60,
                    formula: function(row) {
                        return row.centerId1;
                    }
                }, {
                    name: 'centerId2',
                    title: 'ID 2',
                    width: 60,
                    formula: function(row) {
                        return row.centerId2;
                    }
                }, {
                    name: 'centerId3',
                    title: 'ID 3',
                    width: 60,
                    formula: function(row) {
                        return row.centerId3;
                    }
                }]
            },{
                name: 'assembly',
                title: 'Assembly',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.assembly);
                    return n;
                }
            }, {
                name: 'genes',
                title: 'Genes',
                width: 60
            }, {
                name: 'band',
                title: 'Band',
                width: 60,
                formula: function(row){
                    var n = me.transformData(row.band);
                    return n;
                }
            }, {
                name: 'type',
                title: 'Type',
                width: 60,
                formula: function(row){
                    var n = me.transformData(row.type);
                    return n;
                }
            }, {
                name: 'doses',
                title: 'Doses',
                width: 60,
                formula: function (row) {
                    var n = me.transformData(row.doses);
                    return n;
                }
            },{
                name: 'dosesnum',
                title: 'Mean log2 ratio',
                width: 60,
                formula: function (row) {
                    var n =  me.transformData(row.dosesNum);
                    return n;
                }
            }, {
                name: 'clinicalSig',
                title: 'Clinical Significance',
                width: 150,
                formula: function(row){
                    var n = "."
                    if(row.clinicalSig == ""){
                        return n;
                    }else{
                        return row.clinicalSig;
                    }
                    return n;
                }
            }, {
                name: 'inheritance',
                title: 'Inheritance',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.inheritance);
                    return n;
                }
            }, {
                name: 'nv',
                title: 'Nº of variants',
                width: 90,
                formula: function(row){
                    var n = me.transformData(row.nv);
                    return n;
                }
            }, {
                name: 'cellLine',
                title: 'Cell Line',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.cellLine);
                    return n;
                }
            }, {
                name: 'chromGender',
                title: 'Chr gender',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.chromGender);
                    return n;
                }
            }, {
                name: 'status',
                title: 'Status',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.status);
                    return n;
                }
            }, {
                name: 'typeSample',
                title: 'Type of Sample',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.typeSample);
                    return n;
                }
            }, {
                name: 'referalDiag',
                title: 'Referal Diagnosis',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.referalDiag);
                    return n;
                }
            }, {
                name: 'phenotype',
                title: 'Phenotype(HPO)',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.phenotype);
                    return n;
                }
            }, {
                name: 'yearOfBirth',
                title: 'Year Birth',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.yearOfBirth);
                    return n;
                }
            }, {
                name: 'yearTest',
                title: 'Year Test',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.yearTest);
                    return n;
                }
            }, {
                name: 'age',
                title: 'Age',
                width: 80
            }, {
                name: 'agePrenatal',
                title: 'Age Prenatal',
                width: 80,
                formula: function(row){
                    var n = "."
                    if(row.agePrenatal == 0){
                        return n;
                    }else{
                        return row.agePrenatal;
                    }
                }
            }, {
                name: 'ethnicGroup',
                title: 'Ethnic Group',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.ethnicGroup);
                    return n;
                }
            }, {
                name: 'origin',
                title: 'Greographic Origin',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.origin);
                    return n;
                }
            }, {
                name: 'arrayPlatform',
                title: 'Array Platform',
                width: 120,
                formula: function(row){
                    var n = me.transformData(row.arrayPlatform);
                    return n;
                }
            }, {
                name: 'arrayId',
                title: 'Array ID',
                width: 80,
                formula: function(row){
                    var n = me.transformData(row.arrayId);
                    return n;
                }
            }, {
                name: 'syndromeName',
                title: 'Sindrome',
                width: 80,
                formula: function (row) {
                    var syndromeParse;
                    if (row.syndromeName == null || row.syndromeName == "") {
                        syndromeParse = "."
                    } else {
                        syndromeParse = row.syndromeName;
                    }
                    return syndromeParse;
                }
            }, {
                name: 'comments',
                title: 'Comments',
                width: 120

            },{
                name: 'author',
                title: 'Author',
                width: 120
            }, {
                name:'organization',
                title:'Organization',
                width: 120
            },{
                name: 'codeDecipher',
                title: 'Code',
                width: 90,
                visible:false,
                columns: [{
                    name: 'decipher',
                    title: 'Decipher',
                    width: 90,
                    formula: function (row) {
                        return me.transformData(row.code) + "</br>" + me.transformData(row.decipherId);
                    }
                }]
            },{
                name: 'LocalIDmerge',
                title: 'Local ID(1,2,3)',
                width: 180,
                visible:false,
                formula: function(row) {
                    return row.centerId1 +"<br/>"+row.centerId2+"</br>"+row.centerId3;
                }
            },{
                name: 'position2',
                title: 'Chr',
                width: 100,
                visible:false,
                columns: [{
                    name: 'start',
                    title: 'Start',
                    width: 100,
                    columns: [{
                        name: 'end',
                        title: 'End',
                        width: 100,
                        formula: function (row) {
                            return row.chromosome + "</br>" + row.start + "</br>" + row.end;
                        }
                    }]
                }]
            },{
                name: 'statTypeCell',
                title: 'Status',
                width: 100,
                visible:false,
                columns: [{
                    name: 'typeSample',
                    title: 'Type of Sample',
                    width: 100,
                    columns: [{
                        name: 'cellLine',
                        title: 'Cell Line',
                        width: 100,
                        formula: function (row) {
                            return row.status + "</br>" + row.typeSample + "</br>" + row.cellLine;
                        }
                    }]
                }]
            },{
                name: 'genderCytoAssem',
                title: 'Chr Gender',
                width: 100,
                visible:false,
                columns: [{
                    name: 'band',
                    title: 'Cytoband',
                    width: 100,
                    columns: [{
                        name: 'assembly',
                        title: 'Assembly',
                        width: 100,
                        formula: function (row) {
                            return row.chromGender + "</br>" + row.band + "</br>" + row.assembly;
                        }
                    }]
                }]
            },{
                name: 'nvTypeCopy',
                title: 'Nº of variants',
                width: 120,
                visible:false,
                columns: [{
                    name: 'type',
                    title: 'Type variant',
                    width: 120,
                    columns: [{
                        name: 'dosis',
                        title: 'Copy Number',
                        width: 120,
                        formula: function (row) {
                            var n = me.transformData(row.nv);
                            var t = me.transformData(row.type);
                            var d = me.transformData(row.doses);
                            return n + "</br>" + t + "</br>" + d;
                        }
                    }]
                }]
            }, {
                name: 'size',
                title: 'Size(nt)',
                width: 100,
                visible:false,
                formula: function(row) {
                    return row.end - row.start;
                }
            }, {
                name: 'genes',
                title: 'Genes',
                width: 100,
                visible:false,
            },{
                name: 'refDiagnosis',
                title: 'Ref Diagnosis',
                width: 120,
                visible:false,
                columns: [{
                    name: 'syndrome',
                    title: 'Aneuploidy Sindrome',
                    width: 120,
                    formula: function (row) {
                        var syndromeParse;
                        if(row.syndromeName == null){
                            syndromeParse = "."
                        }else{
                            syndromeParse = row.syndromeName;
                        }
                        return  row.referalDiag +"</br>" +syndromeParse;
                    }
                }]
            },{

                name: 'phenotype',
                title: 'Phenotype(HPO)',
                width: 120,
                visible:false,
            },{
                name: 'cliSInheri',
                title: 'Clinical Significance',
                width: 140,
                visible:false,
                columns: [{
                    name: 'inheritance',
                    title: 'Inheritance',
                    width: 140,
                    formula: function (row) {
                        return row.clinicalSig + "</br>" + row.inheritance;
                    }
                }]
            },{
                name: 'birthTestAge',
                title: 'Birth year', //Birth year, Test year, Age Age(pr)
                width: 100,
                visible:false,
                columns: [{
                    name: 'yearTest',
                    title: 'Test year',
                    width: 100,
                    columns: [{
                        name: 'ageAgePrenatal',
                        title: 'Age Age(pr)',
                        width: 100,
                        formula: function(row) {
                            return  row.yearOfBirth +"</br>" + row.yearTest + "</br>" + row.age + " "+ row.agePrenatal;
                        }
                    }]
                }]
            },{

                name: 'ethnicGeo',
                title: 'Ethnic Group',
                width: 100,
                visible:false,
                columns: [{
                    name: 'origin',
                    title: 'Geog Origin',
                    width: 100,
                    formula: function (row) {
                        return row.ethnicGroup + "</br>" + row.origin;
                    }
                }]
            },{
                name: 'arrays',
                title: 'Array Platf',
                width: 100,
                visible:false,
                columns: [{
                    name: 'arrayID',
                    title: 'Array ID',
                    width: 100,
                    formula: function(row) {
                        return  row.arrayPlatform +"</br>" +row.arrayId;
                    }
                }]
            },{
                name: 'comments2',
                title: 'Comments',
                width: 90,
                visible:false

            },{
                name: 'authorOrga',
                title: 'Author',
                width: 120,
                visible:false,
                columns:[{
                    name:'organization',
                    title:'Organization',
                    width: 120,
                    formula: function(row){
                        return row.author + "</br>" + row.organization;
                    }
                }]
            }

            ]

        },
        transformData: function(row){
            var n = "."
            if(row == 0 || row == ""){
                return n;
            }else{
                return row;
            }

        },
        created: function() {
            this.selectedSpecies = DEFAULT_SPECIES;
        },
        clearForm: function() {
            this.$.formAdd.reset();
            this.localIdValue1 = null;
            this.localIdValue2 = null;
            this.localIdValue3 = null;
            this.regionValue = "";
            this.geneValue = "";
            this.arrayPlataformValue = null;
            this.arrayIdValue = null;
            this.rdValue = null;
            this.hpoValue = [];
            this.hpoSearch = "";
            this.aneuploidValue = null;
            this.localIdValue = null;
            this.decipherIdValue = null;
            this.yearIdValue = null;
            this.yearTestValue = null;
            this.ageValue = null;
            this.codeValue = null;
            this.ethnicValue = null;
            this.geoValue = null;

        },
        _parse: function(response) {
            var data = response.result;
            var positions = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var variant = row.chromosome + ":" + row.start + "-" + row.end;
                positions.push(variant);
            }

            // Annotate
            var query = positions.join(",");
            if (positions.length > 0) {

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'region',
                    resource: 'gene',
                    query: query,
                    params: {
                        exclude: "transcripts,chunkIds,expressionValues,_chunkIds,mirna"
                    },
                    async: false,
                    success: function(response) {
                        try {
                            for (var i = 0; response != null && i < response.response.length; i++) {
                                var result = response.response[i].result;

                                var genes = [];
                                for (var j = 0; j < result.length; j++) {
                                    var gene = result[j];
                                    genes.push(gene.name);
                                }

                                data[i].genes = genes.join(",");
                            }
                        } catch (e) {}
                    }
                });
            }
            return data;
        },
        _parseTotal: function(response) {
            return response.numTotalResults;
        },
        urlChanged: function(neo, old) {
            var me = this;
            if (neo != '') {
                this.request = {
                    url: this.formURL,
                    parse: this._parse,
                    parseTotal: this._parseTotal,
                    file: this.file
                };
            }
        },
        dosesAndSizeNumValidity: function(){
            if(this.dosesValue != null){
                if(isNaN(this.dosesValue)) {
                    alert("doses Number is not a number, check the form");
                    return (false);
                }
            }
            if(this.sizeValue != null){
                if(isNaN(this.sizeValue)) {
                    alert("The size is not a number, check the form");
                    return (false);
                }
            }
            return true;
        },
        upload: function() {
            var me = this;
            var query = {};
            query.user = Cookies('bioinfo_user');
            query.sid = Cookies('bioinfo_sid');
            var url = CNVSManager.management.add({
                query:query,
                request: {
                    method:"POST",
                    headers:{
                        "Content-Type":"aplicaction/json"
                    },
                    body: JSON.stringify(me.$.tablaread.data,"",""),
                    success: function(response) {
                        try {
                            alert("Add correct. "+ response.result + "insertadas.");
                        } catch (e) {}
                    }
                }
            });
        },
        cleanTable:function(){
            this.newRow = null;
        },
        submitForm: function() {
            var me = this;
            var query = {};

            //  if (this.$.form.checkValidity() && (this.regionValue != '' || this.geneValue != '')) {
            if (this.$.formAdd.checkValidity() && this.dosesAndSizeNumValidity()) {
                var region = null;
                if (this.regionValueC == "") { //TODO
                    region = "";
                } else {
                    region = new Region(this.regionValue.trim());
                    query.regions = region;
                }

                if(!this.localIdValue1 == ""){
                    query.centerId1 = this.localIdValue1;
                }

                if(!this.localIdValue2 == ""){
                    query.centerId2 = this.localIdValue2;
                }

                if(!this.localIdValue3 == ""){
                    query.centerId3 = this.localIdValue3;
                }

                var inputs = this.$.typeAdd.querySelectorAll("input");
                var typev = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputtype = inputs[i];
                    if (inputtype.checked) {
                        typev.push(inputtype.value);
                    }
                }
                if (typev.length > 0 && typev.length < 3) {
                    query.type = typev.join(",");
                }
                if(!this.codeValue == ""){
                    query.code = this.codeValue;
                }
                if(!this.decipherIdValue == ""){
                    query.decipherId = this.decipherIdValue;
                }
                inputs = this.$.assemblyAdd.querySelectorAll("input");
                var assemblyv = [];
                for (var i = 0; i < inputs.length; i++){
                    if(inputs[i].checked){
                        assemblyv.push(inputs[i].value);
                    }
                }
                if (assemblyv.length > 0 && assemblyv.length < 3) {
                    query.assembly = assemblyv.join(",");
                }

                inputs = this.$.dosesAdd.querySelectorAll("input");
                var dosesv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputdoses = inputs[i];
                    if (inputdoses.checked) {
                        dosesv.push(inputdoses.value);
                    }
                }
                if (dosesv.length > 0 && dosesv.length < 4) {
                    query.doses = dosesv.join(",");
                }
                if(!this.sizeValue == ""){
                    // query.size = this.sizeValue; //TODO
                }
                if(!this.bandValue == ""){
                    query.band = this.bandValue;
                }


                inputs = this.$.clisAdd.querySelectorAll("input");
                var clisv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputclis = inputs[i];
                    if (inputclis.checked) {
                        clisv.push(inputclis.value);
                    }
                }
                if (clisv.length > 0 && clisv.length < 5) {
                    query.clis = clisv.join(",");
                }

                inputs = this.$.inheritanceAdd.querySelectorAll("input");
                var inhev = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputinhe = inputs[i];
                    if (inputinhe.checked) {
                        inhev.push(inputinhe.value);
                    }
                }
                if (inhev.length > 0 && inhev.length < 4) {
                    query.inheritance = inhev.join(",");
                }

                if(!this.nvariantsValue == "") {
                    query.nv = this.nvariantsValue;
                }
                inputs = this.$.clAdd.querySelectorAll("input");
                var clv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputcl = inputs[i];
                    if (inputcl.checked) {
                        clv.push(inputcl.value);
                    }
                }
                if (clv.length > 0 && clv.length < 2) {
                    query.cl = clv.join(",");
                }

                inputs = this.$.genderAdd.querySelectorAll("input");
                var genderv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputgender = inputs[i];
                    if (inputgender.checked) {
                        genderv.push(inputgender.value);
                    }
                }
                if (genderv.length > 0 && genderv.length < 2) {
                    query.gender = genderv.join(",");
                }

                inputs = this.$.statusAdd.querySelectorAll("input");
                var statusv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputstatus = inputs[i];
                    if (inputstatus.checked) {
                        statusv.push(inputstatus.value);
                    }
                }
                if (statusv.length > 0 && statusv.length < 4) {
                    query.status = statusv.join(",");
                }

                inputs = this.$.typeSAdd.querySelectorAll("input");
                var typeSv = [];

                for (var i = 0; i < inputs.length; i++) {
                    var inputtypeS = inputs[i];
                    if (inputtypeS.checked) {
                        typeSv.push(inputtypeS.value);
                    }
                }
                if (typeSv.length > 0 && typeSv.length < 5) {
                    query.typeS = typeSv.join(",");
                }

                if(!this.rdValue == "") {
                    query.referalDiag = this.rdValue;
                }

                //Comprobar que todos son números
                if(!this.yearIdValue == "") {
                    query.year = this.yearIdValue;
                }

                if(this.ethnicValue.length >0) {
                    query.ethnic = this.ethnicSearch;
                }


                if(!this.geoValue == "") {
                    query.geo = this.geoValue;
                }
                if(!this.arrayPlataformValue == "") {
                    query.arrayPlatform = this.arrayPlataformValue;
                }
                if(!this.arrayIdValue == "") {
                    query.arrayId = this.arrayIdValue;
                }
                if(!this.localIdValue == "") {
                    query.localId = this.localIdValue;
                }
                if( this.dosesValue!= null && !this.dosesValue == "" ){
                    query.dosesNum = this.dosesValue;
                    query.dosesOp = this.$.dosesOpAdd.value;
                }

                if( this.sizeValue!= null && !this.sizeValue == "" ){
                    query.size = this.sizeValue;
                    query.sizesigno = this.$.sizeOpAdd.value;
                }

                var hpov = [];
                for (var i = 0; i < this.hpoValue.length; i++) {
                    if (this.hpoValue[i].id.indexOf('HP:') >= 0) { // Si viene del arbol no tiene HP:
                        hpov[i] = this.hpoValue[i].id;
                    } else {
                        hpov[i] ='HP:' + this.hpoValue[i].id;
                    }
                    if (this.hpoValue[i].f != null) { //f son los hijos parent el padre
                        if (Object.keys(this.hpoValue[i].f).length > 0) {
                            for (var j = 0; j < this.hpoValue[i].f.length; j++) {
                                this.hpoValue.push(this.hpoValue[i].f[j]);
                            }
                        }
                    }
                }
                this.hpoValue = [];
                if (hpov.length > 0) {
                    query.hpo = hpov.join(",");
                }
                var url = CNVSManager.regions.fetch({
                    query: query,
                    request: {
                        url: true
                    }
                });

                this.formURL = url;
                console.log(url);

                this.adapter.params = query;

                this.query = query;
            } else {
                alert("Please check the form");
            }
        }
    });
</script>
